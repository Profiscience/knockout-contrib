!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("knockout")):"function"==typeof define&&define.amd?define(["knockout"],e):(t.ko=t.ko||{},t.ko.contrib=t.ko.contrib||{},t.ko.contrib.Query=e(t.ko))}(this,function(t){"use strict";function e(t){return"boolean"==typeof t}function r(t){return 0===t.length}function n(t){return!isNaN(parseFloat(t))}function i(t){return void 0===t}function o(t){return Object.keys(t).map(function(e){return[e,t[e]]})}function u(t,e){for(var r={},n=0,i=o(t);n<i.length;n++){var u=i[n],a=u[0],c=u[1];e(c)||(r[a]=c)}return r}return function(){function a(t,e){this._group=e,i(a._raw[this._group])?(a._raw[this._group]={},a._refs[this._group]=1):a._refs[this._group]++,this.set(t)}return a.prototype.set=function(e){var r=this;this._config=e,this._defaults=Object.assign({},this._defaults||{},a.getDefaults(e));var n=this._group,u=a.fromQS(n);o(e).forEach(function(t){var e=t[0],o=t[1],c=void 0===o?{}:o;if(r[e]=a._raw[n][e],i(r[e])){var s=r._defaults[e],f=c.coerce||function(t){return t},p=i(u[e])?c.initial:u[e];r[e]=a._raw[n][e]=a.createQueryParam(n,e,s,p,f)}else r[e].set(c)}),t.tasks.runEarly()},a.prototype.toJS=function(){return u(t.toJS(a._raw[this._group]),i)},a.prototype.toString=function(){return a.stringify(this.toJS())},a.prototype.asObservable=function(){var e=this;return this._forceRecompute||(this._forceRecompute=t.observable(!1)),t.pureComputed(function(){return e._forceRecompute(),e.toJS()})},a.prototype.clear=function(){var t=this;Object.keys(a._raw[this._group]).forEach(function(e){return a._raw[t._group][e].clear()})},a.prototype.dispose=function(){if(0==--a._refs[this._group]){var t=Object.assign({},a.fromQS(),a.getCleanQuery());delete t[this._group],a.writeQueryString(t),delete a._raw[this._group]}},a.parse=function(t){return a._parser.parse(t)},a.stringify=function(t){return a._parser.stringify(t)},a.create=function(t,e){return new a(t,e)},a.setParser=function(t){a._parser=t},a.getQueryString=function(){var t=/\?([^#]*)/.exec(location.search+location.hash);return t?t[1]:""},a.fromQS=function(t){var e=this.parse(this.getQueryString());return(i(t)?e:e[t])||{}},a.getCleanQuery=function(){for(var c={},s=0,f=o(a._raw);s<f.length;s++){var p=f[s],h=p[0],l=p[1];c[h]=t.toJS(u(l,function(t){return t.isDefault()||i(t())||r(t())&&!n(t())&&!e(t())}))}return c[void 0]&&(Object.assign(c,c[void 0]),delete c[void 0]),c},a.writeQueryString=function(t){t||(t=this.getCleanQuery());var e=a.stringify(t),r=location.pathname+location.search+location.hash,n=/([^?#]*)/.exec(r)[1],i=/(#[^!]*)/.exec(r),o=n;e&&(o+="?"+e),i&&(o+=i[1]),history.replaceState(history.state,document.title,o)},a.queueQueryStringWrite=function(){var e=this;return this._queuedUpdate||(this._queuedUpdate=new Promise(function(r){t.tasks.schedule(function(){a.writeQueryString(),r(),e._queuedUpdate=!1})})),this._queuedUpdate},a.createQueryParam=function(e,r,n,o,u){var c=this,s=t.observable(t.toJS(n)),f=t.observable(i(o)?s():o),p=t.pureComputed(function(){return h()===s()}),h=t.pureComputed({read:function(){return f()},write:function(t){i(t)&&(t=s()),u&&(t=u(t)),f(t),a.queueQueryStringWrite().catch(function(t){return console.error("[@profiscience/knockout-contrib-querystring] error queueing write")})}});return Object.assign(h,{isDefault:p,set:function(t){c.isParamConfigObject(t)?(t.coerce&&(u=t.coerce),(p()||i(h())||!i(t.initial))&&h(i(t.initial)?t.default:t.initial),t.default&&s(t.default)):((p()||i(h()))&&h(t),s(t))},clear:function(){return h(s())}}),h},a.isParamConfigObject=function(t){return t&&(t.default||t.initial||t.coerce)},a.getDefaults=function(t){var e=this,r={};return o(t).forEach(function(t){var n=t[0],i=t[1];return r[n]=e.isParamConfigObject(i)?i.default:i}),r},a._raw={},a._refs={},a._parser={parse:function(t){return JSON.parse(decodeURIComponent(t||"{}"))},stringify:function(t){return"{}"===JSON.stringify(t)?"":encodeURIComponent(JSON.stringify(t))}},a}()});